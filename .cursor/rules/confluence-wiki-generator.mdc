# Confluence Wiki 자동 생성 규칙

## 트리거 조건

사용자가 다음과 같은 요청을 할 때 이 규칙을 적용합니다:
- "위키 생성해줘"
- "컨플루언스 만들어줘"
- "confluence 페이지 만들어줘"

## 표준 프롬프트 포맷

사용자는 다음 포맷으로 정확하게 요청해야 합니다:

### 포맷 1: 기존 페이지 복제 (권장)

```
@.cursor/rules/confluence-wiki-generator.mdc 
[원본 페이지 URL] 을 [대상 페이지 URL] 위키 생성해줘
```

**예시:**
```
@.cursor/rules/confluence-wiki-generator.mdc 
https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/882901069/2.0 
을 
https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/1176109101/2.0 
위키 생성해줘
```

### 포맷 2: 원본 URL + 텍스트 (혼합)

```
@.cursor/rules/confluence-wiki-generator.mdc 
[원본 페이지 URL] 
[추가 텍스트 내용]
위키 생성해줘
```

### 포맷 3: 텍스트만 제공

```
@.cursor/rules/confluence-wiki-generator.mdc 
[마크다운 또는 텍스트 내용]
위키 생성해줘
```

## 입력 형식 상세

### Confluence URL 형식
```
https://mrtcx.atlassian.net/wiki/spaces/[SPACE]/pages/[PAGE_ID]
또는
https://mrtcx.atlassian.net/wiki/spaces/[SPACE]/pages/[PAGE_ID]/[TITLE]
```

### 텍스트 내용 형식
```
제목, 본문, 표 등의 텍스트 내용을 직접 제공
마크다운 형식 또는 일반 텍스트
```

## 출력 형식 (표준 템플릿)

### 1. 페이지 구조

```markdown
# [메인 제목]

## [소개 섹션]

[안내 메시지 - info 박스]

## 목차

[자동 생성 TOC]

---

## 🔗 참고 자료

- [링크 1]
- [링크 2]
- [링크 3]

---

## 📊 [메인 콘텐츠 제목]

### [서브 섹션 1]

[Mermaid 다이어그램 이미지]

---

### [서브 섹션 2]

[Mermaid 다이어그램 이미지]

---
```

### 2. Confluence HTML Storage Format

생성된 마크다운을 다음 Confluence HTML 형식으로 변환합니다:

```html
<h2>목차</h2>
<ac:structured-macro ac:name="toc" ac:schema-version="1">
  <ac:parameter ac:name="printable">true</ac:parameter>
  <ac:parameter ac:name="maxLevel">3</ac:parameter>
  <ac:parameter ac:name="minLevel">1</ac:parameter>
</ac:structured-macro>

<hr />

<h2>🔗 참고 자료</h2>
<ul>
<li><a href="[URL]">[링크 텍스트]</a></li>
</ul>

<hr />

<h2>📊 프로세스 플로우차트</h2>

<p>
<ac:image ac:width="1200">
<ri:attachment ri:filename="[이미지파일명].png" />
</ac:image>
</p>
```

**이미지 표시 규칙:**
- 모든 Mermaid 다이어그램 이미지는 `ac:width="1200"` 고정
- 실제 이미지 해상도: 3000x4000px
- Space 내 모든 페이지의 플로우차트 크기 통일

### 3. 이미지 처리 규칙

**Mermaid 다이어그램이 포함된 경우:**

1. **Mermaid 코드 추출**: 입력에서 모든 Mermaid 코드 블록을 추출합니다
2. **PNG 이미지 변환**: 
   - **우선 방법**: `npx @mermaid-js/mermaid-cli` 사용 (로컬 생성, URI 길이 제한 없음)
   - **대체 방법**: `mermaid.ink` 서비스 사용 (단, URI 길이 제한 주의)
   ```python
   # 로컬 생성 (권장)
   npx mmdc -i input.mmd -o output.png -w 3000 -H 4000 -b transparent
   
   # 또는 mermaid.ink 사용 (간단한 다이어그램만)
   image_url = f"https://mermaid.ink/img/{base64_encoded_mermaid}"
   ```
3. **이미지 다운로드/생성**: `mermaid_images/` 폴더에 저장
4. **Confluence 업로드**: Attachment API로 이미지 업로드
5. **페이지에 삽입**: `<ac:image>` 태그로 이미지 참조

**이미지 품질 표준 (필수):**

- **해상도**: 3000x4000px (고해상도 유지)
- **포맷**: PNG (투명 배경)
- **Confluence 삽입 크기**: `ac:width="1200"` (고정)
- **이모지**: 절대 사용 금지 (가독성 저해)
- **명령어 예시**:
  ```bash
  npx mmdc -i input.mmd -o output.png -w 3000 -H 4000 -b transparent
  ```

**일관성 유지:**
- 같은 Space 내 모든 플로우차트는 동일한 해상도로 생성
- 모든 페이지에 `ac:width="1200"` 적용하여 표시 크기 통일
- 이모지 없이 텍스트만으로 명확하게 표현

**이미지가 없는 경우:**
- 텍스트 콘텐츠만 HTML로 변환하여 업로드

## 워크플로우

### STEP 1: 입력 파싱 및 정보 추출 (자동)

**URL에서 자동으로 추출:**

1. **원본 페이지 URL 파싱**:
   ```
   https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/882901069/2.0
   → Page ID: 882901069
   → Space: aoh
   ```

2. **대상 페이지 URL 파싱**:
   ```
   https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/1176109101/2.0
   → Page ID: 1176109101
   → Space: aoh
   ```

3. **자동 확인 (사용자에게 질문하지 않음)**:
   - ✅ 원본 페이지 ID 추출 완료
   - ✅ 대상 페이지 ID 추출 완료
   - ✅ 바로 작업 시작

**예외: 정보가 불명확한 경우에만 질문**

사용자가 URL을 명확히 제공하지 않았거나 페이지 ID를 찾을 수 없는 경우에만:

```
다음 정보를 확인해주세요:
1. 원본 Confluence 페이지 URL 또는 ID: [PAGE_ID]
2. 대상 Confluence 페이지 URL 또는 ID: [PAGE_ID]

진행하시겠습니까?
```

### STEP 2: 콘텐츠 구조화

**입력 내용을 분석하여 다음 요소로 구조화합니다:**

1. **메인 제목** 추출
2. **섹션 구분** (## 단위)
3. **표 데이터** 파싱
4. **링크** 추출
5. **Mermaid 다이어그램** 추출
6. **리스트 항목** 정리

### STEP 3: 폴더 및 파일 생성

**로컬에 마크다운 파일 생성:**

```
프로젝트_루트/
└── [페이지_제목]/
    ├── [페이지_제목].md          # 마크다운 원본
    ├── [섹션1].md                 # 개별 섹션 (선택적)
    ├── [섹션2].md
    └── mermaid_images/            # 다이어그램 이미지
        ├── diagram1.png
        └── diagram2.png
```

### STEP 4: Python 스크립트 실행

**자동 업로드 스크립트 사용:**

```bash
# 환경 변수 설정
$env:CONFLUENCE_EMAIL = "[사용자_이메일]"
$env:CONFLUENCE_API_TOKEN = "[API_토큰]"

# 스크립트 실행
python confluence_upload_mermaid_images.py
```

### STEP 5: 검증 및 완료

- [ ] 페이지 버전 업데이트 확인
- [ ] 이미지 업로드 확인
- [ ] 링크 정상 작동 확인
- [ ] 목차 자동 생성 확인

## 필수 준수 사항

### 1. 페이지 구성 요소

**반드시 포함해야 하는 요소:**

- ✅ 목차 (TOC 매크로)
- ✅ 구분선 (`<hr />`)
- ✅ 참고 자료 섹션 (링크 있는 경우)
- ✅ 프로세스 플로우차트 이미지

**절대 포함하지 않는 요소:**

- ❌ 작성자 정보 (예: "2025.11 이경진 작성 완료")
- ❌ 페이지 설명 Info 박스
- ❌ "상세 처리 방법은 개별 문서를 참조하세요" 같은 안내 문구

### 2. 스타일 가이드

**제목 레벨:**
- H1: 페이지 메인 제목 (1개만)
- H2: 주요 섹션
- H3: 서브 섹션

**이모지 사용:**
- 📊 데이터/차트 관련
- 🔗 링크/참고자료
- ⚠️ 주의사항
- ✅ 완료/체크리스트
- 📋 목록/개요

**구분선:**
- 주요 섹션 사이에 `<hr />` 사용
- 각 다이어그램 아래에 구분선

### 3. Confluence API 사용

**인증:**
```python
auth = (CONFLUENCE_EMAIL, CONFLUENCE_API_TOKEN)
```

**페이지 업데이트:**
```python
# 1. 현재 버전 가져오기
GET /wiki/rest/api/content/{page_id}?expand=body.storage,version

# 2. 페이지 업데이트
PUT /wiki/rest/api/content/{page_id}
{
  "version": {"number": current_version + 1},
  "title": "페이지 제목",
  "type": "page",
  "body": {
    "storage": {
      "value": "<html content>",
      "representation": "storage"
    }
  }
}
```

**이미지 업로드:**
```python
# 첨부파일 업로드
POST /wiki/rest/api/content/{page_id}/child/attachment
files = {'file': (filename, file_content, 'image/png')}
headers = {"X-Atlassian-Token": "no-check"}
```

## 실전 예제

### 예제 1: 공급사별 반려 처리 가이드

**입력:**
```
https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/752746754
공급사별 반려 처리 방법 위키 생성해줘
```

**출력 구조:**
1. 목차 (자동 생성)
2. 참고 자료 링크 (시트, 슬랙 등)
3. 프로세스 플로우차트 섹션
   - Mermaid 플로우차트 (PNG 이미지, 1000px width)

### 예제 2: 텍스트 기반 입력

**입력:**
```markdown
# 프로세스 가이드

## 개요
이 문서는...

## 처리 방법
1. 단계 1
2. 단계 2

## 참고 자료
- 링크 1: https://...
- 링크 2: https://...
```

**처리:**
1. 마크다운 파싱
2. Confluence HTML로 변환
3. TOC 매크로 삽입
4. 업로드

## Python 스크립트 템플릿

**파일명: `confluence_wiki_generator.py`**

```python
#!/usr/bin/env python3
"""
Confluence Wiki 자동 생성기
"""

import os
import requests
import re
import base64
from pathlib import Path

CONFLUENCE_URL = "https://mrtcx.atlassian.net"
CONFLUENCE_EMAIL = os.getenv("CONFLUENCE_EMAIL")
CONFLUENCE_API_TOKEN = os.getenv("CONFLUENCE_API_TOKEN")
MERMAID_INK_URL = "https://mermaid.ink/img/"

def extract_mermaid(content):
    """Mermaid 코드 추출"""
    pattern = r'```mermaid\n(.*?)\n```'
    return re.findall(pattern, content, re.DOTALL)

def mermaid_to_image_url(mermaid_code):
    """Mermaid를 이미지 URL로 변환"""
    encoded = base64.urlsafe_b64encode(mermaid_code.encode('utf-8')).decode('utf-8')
    return f"{MERMAID_INK_URL}{encoded}"

def markdown_to_confluence_html(markdown_content):
    """마크다운을 Confluence HTML로 변환"""
    html = ""
    
    # 제목 변환
    html = re.sub(r'^# (.+)$', r'<h1>\1</h1>', markdown_content, flags=re.MULTILINE)
    html = re.sub(r'^## (.+)$', r'<h2>\1</h2>', html, flags=re.MULTILINE)
    html = re.sub(r'^### (.+)$', r'<h3>\1</h3>', html, flags=re.MULTILINE)
    
    # 링크 변환
    html = re.sub(r'\[([^\]]+)\]\(([^\)]+)\)', r'<a href="\2">\1</a>', html)
    
    # 리스트 변환
    # ... (추가 변환 로직)
    
    return html

def upload_to_confluence(page_id, title, html_content, images=[]):
    """Confluence에 업로드"""
    
    # 1. 이미지 업로드
    for image in images:
        upload_attachment(page_id, image['path'], image['filename'])
    
    # 2. 페이지 업데이트
    page = get_page(page_id)
    current_version = page["version"]["number"]
    
    update_page(page_id, title, html_content, current_version)
    
    print(f"[SUCCESS] Page updated: version {current_version} -> {current_version + 1}")

# ... (기타 함수들)
```

## 체크리스트

작업 진행 시 다음을 확인합니다:

### 입력 단계
- [ ] 사용자에게 페이지 ID 확인
- [ ] 새 페이지 vs 업데이트 확인
- [ ] 인증 정보 확인 (이메일, API 토큰)

### 처리 단계
- [ ] 콘텐츠 구조 분석 완료
- [ ] Mermaid 코드 추출 (있는 경우)
- [ ] 이미지 생성 및 다운로드 (있는 경우)
- [ ] Confluence HTML 변환 완료

### 업로드 단계
- [ ] 이미지 첨부 완료
- [ ] 페이지 내용 업데이트 완료
- [ ] 버전 번호 증가 확인
- [ ] 페이지 URL 제공

### 최종 확인
- [ ] 목차 정상 표시
- [ ] 이미지 정상 표시
- [ ] 링크 정상 작동
- [ ] 포맷 깨짐 없음

## 에러 처리

### 인증 실패
```
[ERROR] Authentication failed
→ 이메일과 API 토큰을 확인해주세요.
```

### 페이지 없음
```
[ERROR] Page not found (404)
→ 페이지 ID를 확인해주세요.
```

### 이미지 변환 실패
```
[ERROR] Mermaid image conversion failed
→ Mermaid 문법을 확인해주세요.
```

## 환경 설정

### Windows (PowerShell)
```powershell
$env:CONFLUENCE_EMAIL = "your.email@company.com"
$env:CONFLUENCE_API_TOKEN = "your_api_token"
```

### Linux/Mac (Bash)
```bash
export CONFLUENCE_EMAIL="your.email@company.com"
export CONFLUENCE_API_TOKEN="your_api_token"
```

## 명령어 사용 예시

### 예시 1: 기본 사용 (권장)
```
사용자: @.cursor/rules/confluence-wiki-generator.mdc 
       https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/882901069 
       을 
       https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/1176109101 
       위키 생성해줘

AI: [자동 실행]
    1. URL 파싱 (882901069 → 1176109101)
    2. 원본 페이지 내용 가져오기
    3. Mermaid 플로우차트 생성
    4. PNG 이미지 변환
    5. Confluence 업로드
    6. 완료!
```

### 예시 2: 짧은 버전
```
사용자: @.cursor/rules/confluence-wiki-generator.mdc 
       882901069 을 1176109101 위키 생성해줘

AI: [자동 실행]
```

### 예시 3: 설명 포함
```
사용자: @.cursor/rules/confluence-wiki-generator.mdc 
       해외 연동 상품 등록 가이드(882901069)를 
       플로우차트 버전(1176109101)으로 위키 생성해줘

AI: [자동 실행]
```

### 예시 4: 여러 줄로 작성
```
사용자: @.cursor/rules/confluence-wiki-generator.mdc 
       https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/882901069/2.0 
       을 
       https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/1176109101/2.0 
       위키 생성해줘

AI: [자동 실행]
```

## 최종 출력 형식

작업 완료 시 다음 정보를 출력합니다:

```
============================================================
[SUCCESS] Confluence Wiki 생성 완료!
============================================================

📄 페이지: https://mrtcx.atlassian.net/wiki/spaces/aoh/pages/[PAGE_ID]
📊 버전: [OLD] -> [NEW]
🖼️  이미지: [COUNT]개
📝 섹션: [COUNT]개

생성된 파일:
  - [페이지_제목]/[페이지_제목].md
  - mermaid_images/ (이미지 [COUNT]개)

============================================================
```
